# PHASE 2 - C∆† S·ªû D·ªÆ LI·ªÜU APP COINZ
# ======================================

## üéØ M·ª§C TI√äU
X√¢y d·ª±ng h·ªá th·ªëng c∆° s·ªü d·ªØ li·ªáu ƒë·ªÉ ph·ª•c v·ª•:
- ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p ng∆∞·ªùi d√πng
- Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n
- Theo d√µi ho·∫°t ƒë·ªông mining
- H·ªá th·ªëng gi·ªõi thi·ªáu b·∫°n b√®
- L·ªãch s·ª≠ giao d·ªãch

## üèóÔ∏è KI·∫æN TR√öC DATABASE

### 1. LOCAL DATABASE (SQLite)
```
üì± SQLite Database: app_coinz_local.db
‚îú‚îÄ‚îÄ users (B·∫£ng ng∆∞·ªùi d√πng)
‚îú‚îÄ‚îÄ mining_sessions (Phi√™n ƒë√†o coin)
‚îú‚îÄ‚îÄ mining_stats (Th·ªëng k√™ ƒë√†o coin)
‚îú‚îÄ‚îÄ friends (Danh s√°ch b·∫°n b√®)
‚îú‚îÄ‚îÄ transactions (Giao d·ªãch n·ªôi b·ªô)
‚îî‚îÄ‚îÄ settings (C√†i ƒë·∫∑t ·ª©ng d·ª•ng)
```

### 2. SERVER DATABASE (PostgreSQL/MySQL)
```
üåê Server Database: app_coinz_server
‚îú‚îÄ‚îÄ users (Th√¥ng tin ng∆∞·ªùi d√πng)
‚îú‚îÄ‚îÄ user_profiles (H·ªì s∆° chi ti·∫øt)
‚îú‚îÄ‚îÄ mining_sessions (Phi√™n ƒë√†o coin)
‚îú‚îÄ‚îÄ mining_stats (Th·ªëng k√™ t·ªïng h·ª£p)
‚îú‚îÄ‚îÄ referrals (H·ªá th·ªëng gi·ªõi thi·ªáu)
‚îú‚îÄ‚îÄ transactions (Giao d·ªãch)
‚îî‚îÄ‚îÄ wallets (V√≠ coin)
```

## üìä CHI TI·∫æT C·∫§U TR√öC B·∫¢NG

### üîê B·∫¢NG USERS (Ng∆∞·ªùi d√πng)
```sql
-- LOCAL SQLite
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT UNIQUE NOT NULL,           -- UUID t·ª´ server
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,            -- M√£ h√≥a bcrypt
    full_name TEXT NOT NULL,
    phone_number TEXT,
    avatar_url TEXT,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,
    is_active BOOLEAN DEFAULT TRUE
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20),
    avatar_url TEXT,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    referral_code VARCHAR(20) UNIQUE,       -- M√£ gi·ªõi thi·ªáu
    referred_by UUID REFERENCES users(id), -- Ng∆∞·ªùi gi·ªõi thi·ªáu
    total_referrals INTEGER DEFAULT 0       -- T·ªïng s·ªë ng∆∞·ªùi ƒë∆∞·ª£c gi·ªõi thi·ªáu
);
```

### üë§ B·∫¢NG USER_PROFILES (H·ªì s∆° chi ti·∫øt)
```sql
-- SERVER ONLY
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    date_of_birth DATE,
    gender VARCHAR(10),
    country VARCHAR(100),
    city VARCHAR(100),
    address TEXT,
    kyc_status VARCHAR(20) DEFAULT 'pending', -- pending, verified, rejected
    kyc_documents JSONB,                      -- L∆∞u th√¥ng tin KYC
    mining_level INTEGER DEFAULT 1,           -- C·∫•p ƒë·ªô ƒë√†o coin
    total_coins_mined DECIMAL(18,8) DEFAULT 0,
    total_mining_time INTEGER DEFAULT 0,     -- T·ªïng th·ªùi gian ƒë√†o (gi√¢y)
    mining_speed_multiplier DECIMAL(3,2) DEFAULT 1.0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ‚õèÔ∏è B·∫¢NG MINING_SESSIONS (Phi√™n ƒë√†o coin)
```sql
-- LOCAL SQLite
CREATE TABLE mining_sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT UNIQUE NOT NULL,         -- UUID t·ª´ server
    user_id TEXT NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME,
    duration_seconds INTEGER DEFAULT 0,     -- Th·ªùi gian ƒë√†o (gi√¢y)
    coins_mined DECIMAL(18,8) DEFAULT 0,
    mining_speed DECIMAL(10,4) DEFAULT 0,   -- Coins/gi√¢y
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    synced_to_server BOOLEAN DEFAULT FALSE
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE mining_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP,
    duration_seconds INTEGER DEFAULT 0,
    coins_mined DECIMAL(18,8) DEFAULT 0,
    mining_speed DECIMAL(10,4) DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### üìà B·∫¢NG MINING_STATS (Th·ªëng k√™ ƒë√†o coin)
```sql
-- LOCAL SQLite
CREATE TABLE mining_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    date DATE NOT NULL,
    total_coins_mined DECIMAL(18,8) DEFAULT 0,
    total_mining_time INTEGER DEFAULT 0,    -- T·ªïng th·ªùi gian ƒë√†o (gi√¢y)
    sessions_count INTEGER DEFAULT 0,       -- S·ªë phi√™n ƒë√†o
    avg_mining_speed DECIMAL(10,4) DEFAULT 0,
    max_mining_speed DECIMAL(10,4) DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    synced_to_server BOOLEAN DEFAULT FALSE,
    UNIQUE(user_id, date)
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE mining_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    total_coins_mined DECIMAL(18,8) DEFAULT 0,
    total_mining_time INTEGER DEFAULT 0,
    sessions_count INTEGER DEFAULT 0,
    avg_mining_speed DECIMAL(10,4) DEFAULT 0,
    max_mining_speed DECIMAL(10,4) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date)
);
```

### üë• B·∫¢NG FRIENDS (Danh s√°ch b·∫°n b√®)
```sql
-- LOCAL SQLite
CREATE TABLE friends (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    friend_id TEXT NOT NULL,
    friend_email TEXT NOT NULL,
    friend_name TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',    -- pending, accepted, blocked
    referral_bonus DECIMAL(18,8) DEFAULT 0, -- Bonus t·ª´ gi·ªõi thi·ªáu
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    synced_to_server BOOLEAN DEFAULT FALSE,
    UNIQUE(user_id, friend_id)
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE friends (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    friend_id UUID REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'pending',    -- pending, accepted, blocked
    referral_bonus DECIMAL(18,8) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id),
    CHECK (user_id != friend_id)            -- Kh√¥ng th·ªÉ k·∫øt b·∫°n v·ªõi ch√≠nh m√¨nh
);
```

### üîÑ B·∫¢NG REFERRALS (H·ªá th·ªëng gi·ªõi thi·ªáu)
```sql
-- SERVER ONLY
CREATE TABLE referrals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    referrer_id UUID REFERENCES users(id) ON DELETE CASCADE,
    referred_id UUID REFERENCES users(id) ON DELETE CASCADE,
    referral_code VARCHAR(20) NOT NULL,
    bonus_coins DECIMAL(18,8) DEFAULT 0,
    bonus_percentage DECIMAL(5,2) DEFAULT 5.0, -- % bonus t·ª´ mining c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c gi·ªõi thi·ªáu
    status VARCHAR(20) DEFAULT 'active',     -- active, inactive, expired
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(referred_id)                      -- M·ªói ng∆∞·ªùi ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c gi·ªõi thi·ªáu 1 l·∫ßn
);
```

### üí∞ B·∫¢NG WALLETS (V√≠ coin)
```sql
-- LOCAL SQLite
CREATE TABLE wallets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    wallet_address TEXT UNIQUE NOT NULL,
    balance DECIMAL(18,8) DEFAULT 0,
    pending_balance DECIMAL(18,8) DEFAULT 0, -- S·ªë d∆∞ ch·ªù x·ª≠ l√Ω
    total_earned DECIMAL(18,8) DEFAULT 0,    -- T·ªïng ki·∫øm ƒë∆∞·ª£c
    total_spent DECIMAL(18,8) DEFAULT 0,    -- T·ªïng chi ti√™u
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    synced_to_server BOOLEAN DEFAULT FALSE
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE wallets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    wallet_address VARCHAR(255) UNIQUE NOT NULL,
    balance DECIMAL(18,8) DEFAULT 0,
    pending_balance DECIMAL(18,8) DEFAULT 0,
    total_earned DECIMAL(18,8) DEFAULT 0,
    total_spent DECIMAL(18,8) DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### üí∏ B·∫¢NG TRANSACTIONS (Giao d·ªãch)
```sql
-- LOCAL SQLite
CREATE TABLE transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    transaction_id TEXT UNIQUE NOT NULL,     -- UUID t·ª´ server
    user_id TEXT NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,   -- mining, referral, transfer, withdrawal
    amount DECIMAL(18,8) NOT NULL,
    balance_before DECIMAL(18,8) NOT NULL,
    balance_after DECIMAL(18,8) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'pending',   -- pending, completed, failed, cancelled
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    synced_to_server BOOLEAN DEFAULT FALSE
);

-- SERVER PostgreSQL/MySQL
CREATE TABLE transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    transaction_type VARCHAR(20) NOT NULL,
    amount DECIMAL(18,8) NOT NULL,
    balance_before DECIMAL(18,8) NOT NULL,
    balance_after DECIMAL(18,8) NOT NULL,
    description TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    metadata JSONB,                          -- Th√¥ng tin b·ªï sung
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```


### ‚öôÔ∏è B·∫¢NG SETTINGS (C√†i ƒë·∫∑t)
```sql
-- LOCAL SQLite ONLY
CREATE TABLE settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    setting_key VARCHAR(100) NOT NULL,
    setting_value TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, setting_key)
);
```

## üîó QUAN H·ªÜ GI·ªÆA C√ÅC B·∫¢NG

### M·ªëi quan h·ªá ch√≠nh:
```
users (1) ‚îÄ‚îÄ‚Üí (1) user_profiles
users (1) ‚îÄ‚îÄ‚Üí (1) wallets
users (1) ‚îÄ‚îÄ‚Üí (*) mining_sessions
users (1) ‚îÄ‚îÄ‚Üí (*) mining_stats
users (1) ‚îÄ‚îÄ‚Üí (*) transactions
users (1) ‚îÄ‚îÄ‚Üí (*) friends (as user_id)
users (1) ‚îÄ‚îÄ‚Üí (*) friends (as friend_id)
users (1) ‚îÄ‚îÄ‚Üí (*) referrals (as referrer_id)
users (1) ‚îÄ‚îÄ‚Üí (1) referrals (as referred_id)
```

## üöÄ SERVER MI·ªÑN PH√ç ƒê·ªÄ XU·∫§T

### 1. Supabase (PostgreSQL)
- **URL**: https://supabase.com
- **Mi·ªÖn ph√≠**: 500MB database, 50MB file storage
- **T√≠nh nƒÉng**: Real-time, Auth, Storage, Edge Functions
- **∆Øu ƒëi·ªÉm**: D·ªÖ setup, c√≥ dashboard qu·∫£n l√Ω

### 2. PlanetScale (MySQL)
- **URL**: https://planetscale.com
- **Mi·ªÖn ph√≠**: 1 database, 1GB storage
- **T√≠nh nƒÉng**: Branching, Schema migrations
- **∆Øu ƒëi·ªÉm**: Serverless, auto-scaling

### 3. Railway (PostgreSQL/MySQL)
- **URL**: https://railway.app
- **Mi·ªÖn ph√≠**: $5 credit/th√°ng
- **T√≠nh nƒÉng**: Auto-deploy, monitoring
- **∆Øu ƒëi·ªÉm**: D·ªÖ deploy, c√≥ nhi·ªÅu add-ons

### 4. Neon (PostgreSQL)
- **URL**: https://neon.tech
- **Mi·ªÖn ph√≠**: 3GB storage, 10GB transfer
- **T√≠nh nƒÉng**: Serverless, branching
- **∆Øu ƒëi·ªÉm**: T·ªëi ∆∞u cho development

## üì± LOCAL DATABASE SETUP

### SQLite v·ªõi Flutter:
```yaml
dependencies:
  sqflite: ^2.3.0
  path: ^1.8.3
  path_provider: ^2.1.1
```

### Database Helper Class:
```dart
class DatabaseHelper {
  static Database? _database;
  static const String _databaseName = 'app_coinz_local.db';
  static const int _databaseVersion = 1;
  
  // Singleton pattern
  static Future<Database> get database async {
    _database ??= await _initDatabase();
    return _database!;
  }
  
  static Future<Database> _initDatabase() async {
    String path = join(await getDatabasesPath(), _databaseName);
    return await openDatabase(
      path,
      version: _databaseVersion,
      onCreate: _onCreate,
      onUpgrade: _onUpgrade,
    );
  }
}
```

## üîÑ SYNC STRATEGY

### 1. Offline-First Approach:
- Local database l√†m primary
- Sync v·ªõi server khi c√≥ internet
- Conflict resolution cho data conflicts

### 2. Sync Methods:
- **Real-time**: WebSocket cho mining sessions
- **Batch**: HTTP API cho historical data
- **Background**: Sync khi app idle

### 3. Data Priority:
- Server data c√≥ priority cao h∆°n local
- User preferences sync t·ª´ local l√™n server
- Mining data sync t·ª´ local l√™n server

## üìä INDEXES & PERFORMANCE

### Indexes c·∫ßn thi·∫øt:
```sql
-- Users table
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_referral_code ON users(referral_code);

-- Mining sessions
CREATE INDEX idx_mining_sessions_user_id ON mining_sessions(user_id);
CREATE INDEX idx_mining_sessions_start_time ON mining_sessions(start_time);

-- Transactions
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);

-- Friends
CREATE INDEX idx_friends_user_id ON friends(user_id);
CREATE INDEX idx_friends_friend_id ON friends(friend_id);
```

## üîí SECURITY CONSIDERATIONS

### 1. Data Encryption:
- Password: bcrypt v·ªõi salt
- Sensitive data: AES encryption
- API keys: Secure storage

### 2. Access Control:
- JWT tokens cho authentication
- Role-based permissions
- Rate limiting cho API

### 3. Data Privacy:
- GDPR compliance
- Data anonymization
- User consent management

---

## üìã IMPLEMENTATION ROADMAP

### Week 1-2: Local Database
- [ ] Setup SQLite v·ªõi Flutter
- [ ] T·∫°o database schema
- [ ] Implement CRUD operations
- [ ] Unit tests cho database

### Week 3-4: Server Database
- [ ] Ch·ªçn v√† setup server mi·ªÖn ph√≠
- [ ] T·∫°o database schema tr√™n server
- [ ] Implement API endpoints
- [ ] Authentication system

### Week 5-6: Sync System
- [ ] Implement sync logic
- [ ] Conflict resolution
- [ ] Background sync
- [ ] Error handling

### Week 7-8: Testing & Optimization
- [ ] Integration tests
- [ ] Performance optimization
- [ ] Security audit
- [ ] Documentation

---

**T·ªïng k·∫øt**: C·∫•u tr√∫c CSDL n√†y s·∫Ω h·ªó tr·ª£ ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng c·ªßa Phase 2, v·ªõi kh·∫£ nƒÉng m·ªü r·ªông cho Phase 3. Local database ƒë·∫£m b·∫£o app ho·∫°t ƒë·ªông offline, server database ƒë·∫£m b·∫£o data consistency v√† real-time features. 

**Thay ƒë·ªïi trong phi√™n b·∫£n n√†y:**
- ‚úÖ ƒê√£ x√≥a b·∫£ng `notifications` - s·ª≠ d·ª•ng local storage cho th√¥ng b√°o
- ‚úÖ ƒê√£ x√≥a b·∫£ng `app_settings` - ch·ªâ s·ª≠ d·ª•ng local settings
- ‚úÖ ƒê√£ ƒë∆°n gi·∫£n h√≥a b·∫£ng `mining_sessions` - b·ªè c√°c tr∆∞·ªùng ph·ª©c t·∫°p nh∆∞ device_info v√† ip_address
